#!/usr/bin/perl
use strict;
use warnings;
use Time::HiRes qw(time);

my $katUrl = "kat.cr";
my $defaultSort="field=size&sorder=desc";

my $usage = "Usage: $0 WORD [WORD ..]\n";

sub getKatHtml($$);
sub run(@);

sub main(@){
  while(@_ > 0 and $_[0] =~ /^-/){
    die $usage;
  }
  my $html = getKatHtml "@_", $defaultSort;

}

sub getKatHtml($$){
  my ($query, $sort) = @_;

  my $url = "$katUrl/usearch/$query?$sort";
  my $tmpFile = "/tmp/kickasstorrents-" . int(time*1000);
  run "wget", $url, "-O", $tmpFile;

  if(-f $tmpFile){
    run "mv", $tmpFile, "$tmpFile.gz";
    run "gunzip $tmpFile.gz >/dev/null 2>/dev/null";
    if(-f "$tmpFile.gz"){
      run "mv", "$tmpFile.gz", $tmpFile;
    }
  }

  my $html = `cat $tmpFile`;
  run "rm", $tmpFile;

  print "="x30 . "\n";

  return $html;
}

sub run(@){
  print "@_\n";
  system @_;
}

&main(@ARGV);
