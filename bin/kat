#!/usr/bin/perl
use strict;
use warnings;
use Time::HiRes qw(time);

my $katUrl = "kat.cr";
my $defaultSort="field=size&sorder=desc";

my $usage = "Usage: $0 WORD [WORD ..]\n";

sub getKatHtml($$);
sub parseTorrents($);
sub run(@);

sub main(@){
  while(@_ > 0 and $_[0] =~ /^-/){
    die $usage;
  }
  my $html = getKatHtml "@_", $defaultSort;

  my @torrents = parseTorrents($html);

}

sub getKatHtml($$){
  my ($query, $sort) = @_;

  my $url = "$katUrl/usearch/$query?$sort";
  my $tmpFile = "/tmp/kickasstorrents-" . int(time*1000);
  run "wget", $url, "-O", $tmpFile;

  if(-f $tmpFile){
    run "mv", $tmpFile, "$tmpFile.gz";
    run "gunzip $tmpFile.gz >/dev/null 2>/dev/null";
    if(-f "$tmpFile.gz"){
      run "mv", "$tmpFile.gz", $tmpFile;
    }
  }

  my $html = `cat $tmpFile`;
  run "rm", $tmpFile;

  print "="x30 . "\n";

  return $html;
}

sub parseTorrents($){
  my $html = shift;

  my $tag = "[^<>]*";
  my $otag = "[^<>\\/]*";
  my $ws = "[ \\t\\n]*";

  my @trs;
  for(my $i=0; $i<length $html; $i++){
    my $substr = substr $html, $i, (length $html) - $i;
    if($substr =~ /^<tr\W/){
      my $tr = $substr;
      $tr =~ s/(<\s*\/\s*tr\s*>).*/$1/s;
      push @trs, $tr;
    }
  }

  my $index = 1;

  my @torrents;
  for my $tr(@trs){
    if($tr =~ /^               $ws
       <tr$tag>                $ws
         <td$otag> (.*) <\/td> $ws
         <td$otag> (.*) <\/td> $ws
         <td$otag> (.*) <\/td> $ws
         <td$otag> (.*) <\/td> $ws
         <td$otag> (.*) <\/td> $ws
         <td$otag> (.*) <\/td> $ws
       <\/tr>                  $ws
       $/xs){
       my ($nameTD, $sizeTD, $filesTD, $ageTD, $seedTD, $leechTD) =
         ($1, $2, $3, $4, $5, $6);

  return @torrents;
}

sub run(@){
  print "@_\n";
  system @_;
}

&main(@ARGV);
