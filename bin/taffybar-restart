#!/usr/bin/perl
use strict;
use warnings;

my $log = "/tmp/taffybar-log";

sub main(@){
  my $daemon = shift if @_ > 0 and $_[0] =~ /^(-d|--daemon)$/;
  die "Usage: $0 [-d|--daemon]\n" if @_ != 0;
  if(defined $daemon){
    exec "nohup \"$0\" >/dev/null 2>/dev/null &";
  }

  system "killall taffybar-linux-x86_64 2>/dev/null";
  my $ok = 1;
  open TB, "-|", "taffybar 2>&1 | tee $log";
  my $line;
  while($line = <TB>){
    if($line =~ /^Error occurred while loading configuration file\.$/){
      $ok = 0;
      system "alarm -s failure";
    }elsif($line =~ /^Launching custom binary/ and $ok){
      system "alarm -s success" if $ok;
    }
    print $line;
  }
  close TB;

  if(not $ok){
    system "term", "less", $log;
  }
}

&main(@ARGV);
