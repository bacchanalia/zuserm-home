#!/usr/bin/perl
use strict;
use warnings;

my $log = "/tmp/taffybar-log";

my $successCmd = "alarm -s success";
my $failureCmd = "alarm -s failure";

sub main(@){
  my $daemon = shift if @_ > 0 and $_[0] =~ /^(-d|--daemon)$/;
  my $quiet = shift if @_ > 0 and $_[0] =~ /^(-q|--quiet)$/;
  die "Usage: $0 [-d|--daemon] [-q|--quiet]\n" if @_ != 0;
  if(defined $daemon){
    my $cmd = $quiet ? "$0 -q" : "$0";
    exec "nohup $cmd >/dev/null 2>/dev/null &";
  }

  system "killall taffybar-linux-x86_64 2>/dev/null";
  my $ok = 1;
  open TB, "-|", "taffybar 2>&1 | tee $log";
  my $line;
  while($line = <TB>){
    if($line =~ /^Error occurred while loading configuration file\.$/){
      $ok = 0;
      system $failureCmd if not $quiet;
    }elsif($line =~ /^Launching custom binary/ and $ok){
      system $successCmd if $ok and not $quiet;
    }
    print $line;
  }
  close TB;

  if(not $ok){
    system "term", "-r", "cat", $log;
  }
}

&main(@ARGV);
