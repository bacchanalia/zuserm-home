#!/usr/bin/perl
use strict;
use warnings;
use Time::HiRes qw(sleep);

my $logDir = "$ENV{HOME}/.cyphertite/logs";

my $backups = {
  backgrounds => '/home/wolke/Desktop/Backgrounds',
  dcim => '/home/wolke/Desktop/DCIM',
  documents => '/home/wolke/Desktop/Documents',
  games => '/home/wolke/Desktop/Games',
  music => '/media/stuff/Music',
  n9 => '/home/wolke/Code/n9',
  pictures => '/home/wolke/Desktop/Pictures',
  records => '/home/wolke/Desktop/Records',
};

sub getLatestLogFile($);
sub run(@);

my $usage = "Usage:
  $0 NAME
     run 'ct-log NAME DIR'

  NAME => DIR:
    " . join("\n    ", map {"$_ => $$backups{$_}"} sort keys %$backups) . "
";

sub main(@){
  die $usage if @_ != 1 or not defined $$backups{$_[0]};
  my $ctfile = shift;
  my $dir = $$backups{$ctfile};
  if($dir !~ /^(.+)\/([^\/]+)$/){
    die "error parsing dir $dir\n";
  }
  my ($parent, $child) = ($1, $2);
  die "dir not found: $parent\n" if not -d $parent;
  chdir $parent;
  $ENV{PWD} = $parent;

  die "dir not found: $child\n" if not -d $child;

  my $oldLog = getLatestLogFile($ctfile);
  $oldLog = "" if not defined $oldLog;

  run "screen-cmd", "ct-log", $ctfile, $child;

  my $newLog = getLatestLogFile($ctfile);

  if(not defined $newLog or $newLog eq $oldLog){
    sleep 0.5;
    $newLog = getLatestLogFile($ctfile);
  }
  if(not defined $newLog or $newLog eq $oldLog){
    die "no log found for $ctfile\n";
  }
  chomp $newLog if defined $newLog;

  run "tail", "-F", $newLog;
}

sub getLatestLogFile($){
  my $ctfile = shift;
  my @files = sort `find $logDir -name ${ctfile}_*_*.log 2>/dev/null`;
  return @files == 0 ? undef : $files[-1];
}

sub run(@){
  print "@_\n";
  system @_;
}

&main(@ARGV);
