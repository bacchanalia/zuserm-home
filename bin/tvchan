#!/usr/bin/perl
use strict;
use warnings;

my @ext = qw(mkv mp4 avi wmv m2ts);

sub getProcLines(@);

sub main(@){
  my @dirs = @_;
  my @cmd;
  push @cmd, "find";
  for my $dir(@dirs){
    die "\"$dir\" is not a directory\n" if not -d $dir;
    push @cmd, $dir;
  }
  push @cmd, "-false";
  for my $ext(@ext){
    push @cmd, ("-or", "-iname", "*.$ext");
  }

  my $files = getProcLines @cmd;
  chomp foreach @$files;
  while(1){
    my $randIndex = rand @$files;
    my $file = $$files[$randIndex];
    chomp $file;
    my $dur = `duration -n -s "$file"`;
    chomp $dur;
    my $s = rand() * $dur;
    system "mplayer", "-ss", $s, $file;
    if($? != 0){
      print "\nmplayer non-zero exit status, terminating\n";
      exit;
    }
  }
}

sub getProcLines(@){
  open FH, "-|", @_;
  my @lines = <FH>;
  close FH;
  die "Error running \"@_\"\n" if $? != 0;
  return \@lines;
}

&main(@ARGV);
