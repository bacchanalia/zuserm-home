#!/usr/bin/perl
use strict;
use warnings;
use lib `dirname $0 | tr -d '\n'`;
use ScriptScript;

my @corePkgs = qw(ghc haskell-platform xmonad);

my @taffybarDeps = qw(
    libcairo2-dev libglib2.0-dev libgtk2.0-dev libpango1.0-dev libxml2-dev
);


my @cabalPkgs = qw(
    runghc
    gtk2hs-buildtools
    posix-timer
    filesystem-trees
);

my @cabalDebPkgs = map {"libghc-" . lc($_) . "-dev"} qw(
    cassava filemanip
    regex-pcre unixutils utf8-string monad-loops json errors
    cmdargs pureMD5 transformers tagged semigroups data-default dlist
    entropy cereal X11 syb binary largeword split hlint
);

my @taffybarCabalDebDeps = map {"libghc-" . lc($_) . "-dev"} qw(
    cairo dbus gtk dyre HStringTemplate gtk-traymanager xmonad-contrib
    xmonad xdg-basedir enclosed-exceptions
);

sub main(@) {
    getRoot @_;
    run "apt-get", "-y", "install", @corePkgs;
    run "apt-get", "-y", "install", @taffybarDeps;

    run "apt-get", "-y", "install", @cabalDebPkgs;
    run "apt-get", "-y", "install", @taffybarCabalDebDeps;

    runUser "cabal", "update";
    runUser "cabal", "install", @cabalPkgs;

    $ENV{PATH} = "$ENV{HOME}/.cabal/bin:$ENV{PATH}";
    installFromGit "git://github.com/teleshoes/taffybar.git";

    editSimpleConf "/etc/environment", getUsername, {
      "_JAVA_AWT_WM_NONREPARENTING" => "1 #xmonad java reparenting bug",
    };
}

main @ARGV;
