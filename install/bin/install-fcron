#!/usr/bin/perl
use strict;
use warnings;
use lib `dirname $0 | tr -d '\n'`;
use ScriptScript;

my $repo = 'git://git.tuxfamily.org/gitroot/fcron/fcron.git';
my $commit = 'ver3_1_2';
my $tab = "/etc/fcrontab";
my $sourceTab = "$ENV{HOME}/.fcrontab";

my $fcron_pam = getInstallPath "fcron/fcron_pam";
my $fcrontab_pam = getInstallPath "fcron/fcrontab_pam";
my $patch = getInstallPath "fcron/patch";

sub main(@){
  run "sudo", "apt-get", "install", qw(
    adduser debconf dpkg exim4 libc6
    libpam-runtime libpam0g libpam0g-dev libselinux1 libselinux1-dev
    libreadline-dev  libaudit-dev
    autoconf

    docbook docbook-xsl docbook-xml docbook-utils manpages-dev
  );
  run "sudo", "apt-get", "remove", "--purge", "anacron";

  print "\n\n\n\n\n\n";

  my $installDir = "/tmp/fcron";
  if(-e $installDir){
    chdir $installDir;
    run "git", "checkout", $commit;
    if($? != 0){
      run "rm", "-rf", $installDir;
    }
  }

  if(not -e $installDir){
    run "mkdir", $installDir;
    chdir $installDir;
    run "git", "clone", $repo, ".";
    run "git", "checkout", $commit;
    if($? != 0){
      die "Couldnt get repo $repo setup\n";
    }
  }

  print "\n\n\n\n\n\n";

  run "git", "apply", $patch;

  print "\n\n\n\n\n\n";

  run "autoconf";
  run "./configure";
  run "sudo", "make", "install";

  run "sudo", "cp", $fcron_pam, "/etc/pam.d/fcron";
  run "sudo", "cp", $fcrontab_pam, "/etc/pam.d/fcrontab";

  print "\n\n\n\n\n\n";

  run "sudo", "rm", $tab;
  run "sudo", "ln", "-s", $sourceTab, $tab;

  run "sudo", "fcron";
  shell "fcronreset 2>/dev/null";
  print "done\n";
}

&main(@ARGV);
