6,8d5
< import com.backup42.common.User;
< import com.backup42.common.config.CentralConfig;
< import com.backup42.common.config.OrgTypeConfigItem;
10,11d6
< import com.backup42.common.config.ServicePeerConfig;
< import com.backup42.common.config.ServiceUIConfig;
13,14d7
< import com.backup42.desktop.actions.ShowMainWindow;
< import com.backup42.desktop.controllers.MainWindowController;
17d9
< import com.backup42.desktop.interfaces.IModelObserver;
23d14
< import com.backup42.desktop.model.LicenseModel;
25,27d15
< import com.backup42.desktop.model.UserListModel;
< import com.backup42.desktop.model.UserModel;
< import com.backup42.desktop.utils.CPFont;
30,34d17
< import com.backup42.desktop.view.MainWindow.Event.AppActivatedEvent;
< import com.backup42.desktop.view.MainWindow.Event.AppCloseEvent;
< import com.backup42.desktop.view.MainWindow.Event.AppDeactivatedEvent;
< import com.backup42.desktop.view.MainWindow.Event.AppShowEvent;
< import com.backup42.desktop.view.MainWindow.Event.Listener;
41d23
< import com.code42.config.ConfigItem;
43,45d24
< import com.code42.event.IListener;
< import com.code42.event.Listener;
< import com.code42.event.Publisher;
54a34
> import com.code42.messaging.MessageReceiverProxy;
56d35
< import com.code42.os.mac.io.FileManager.FSCatalogInfo;
63,64d41
< import com.code42.swt.util.ActionManager;
< import com.code42.swt.util.SWTExec;
66c43
< import com.code42.swt.view.AppWindowEvent.WindowReadyEvent;
---
> import com.code42.swt.view.AppWindowEvent;
76a54
> 
80a59
> 
83,84d61
< import org.eclipse.swt.widgets.Display;
< import org.eclipse.swt.widgets.Shell;
86,90c63,64
< public class CPDesktop
<   extends Publisher
<   implements SplashWindow.Event.Listener, MainWindow.Event.Listener, IModelObserver
< {
<   private static final com.code42.logging.Logger log = LoggerFactory.getLogger(CPDesktop.class.getName());
---
> public class CliWrapper {
>   private static final com.code42.logging.Logger log = LoggerFactory.getLogger(CliWrapper.class.getName());
92d65
<   private static Display display;
94d66
<   private final Listener listener = new Listener(this);
111c83
<         SystemOut.info(CPDesktop.class, "init", "No JVM temp directory configured!");
---
>         SystemOut.info(CliWrapper.class, "init", "No JVM temp directory configured!");
117c89
<         SystemOut.info(CPDesktop.class, "init", "JVM temp directory " + tmpdirname + " does not exist!");
---
>         SystemOut.info(CliWrapper.class, "init", "JVM temp directory " + tmpdirname + " does not exist!");
122c94
<         SystemOut.info(CPDesktop.class, "init", "JVM temp directory " + tmpdirname + " is not a directory!");
---
>         SystemOut.info(CliWrapper.class, "init", "JVM temp directory " + tmpdirname + " is not a directory!");
127c99
<         SystemOut.info(CPDesktop.class, "init", "JVM temp directory " + tmpdirname + " exists but we can't write to it!");
---
>         SystemOut.info(CliWrapper.class, "init", "JVM temp directory " + tmpdirname + " exists but we can't write to it!");
138,148c110,120
<       SystemOut.info(CPDesktop.class, "init", "*************************************************************");
<       SystemOut.info(CPDesktop.class, "init", "*************************************************************");
<       SystemOut.info(CPDesktop.class, "init", "STARTED " + getAppBaseName() + "Desktop");
<       SystemOut.info(CPDesktop.class, "init", "CPVERSION = " + CPVersion.asString());
<       SystemOut.info(CPDesktop.class, "init", "ARGS      = " + ArrayUtils.toString(args));
<       SystemOut.info(CPDesktop.class, "init", "LOCALE    = " + Locale.getDefault().getDisplayName(Locale.ENGLISH));
<       SystemOut.info(CPDesktop.class, "init", "JVM       = " + jvm);
<       SystemOut.info(CPDesktop.class, "init", "OS        = " + os);
<       SystemOut.info(CPDesktop.class, "init", "User      = " + user);
<       SystemOut.info(CPDesktop.class, "init", "swt.library.path = " + System.getProperty("swt.library.path"));
<       SystemOut.info(CPDesktop.class, "init", "*************************************************************");
---
>       SystemOut.info(CliWrapper.class, "init", "*************************************************************");
>       SystemOut.info(CliWrapper.class, "init", "*************************************************************");
>       SystemOut.info(CliWrapper.class, "init", "STARTED " + getAppBaseName() + "Desktop");
>       SystemOut.info(CliWrapper.class, "init", "CPVERSION = " + CPVersion.asString());
>       SystemOut.info(CliWrapper.class, "init", "ARGS      = " + ArrayUtils.toString(args));
>       SystemOut.info(CliWrapper.class, "init", "LOCALE    = " + Locale.getDefault().getDisplayName(Locale.ENGLISH));
>       SystemOut.info(CliWrapper.class, "init", "JVM       = " + jvm);
>       SystemOut.info(CliWrapper.class, "init", "OS        = " + os);
>       SystemOut.info(CliWrapper.class, "init", "User      = " + user);
>       SystemOut.info(CliWrapper.class, "init", "swt.library.path = " + System.getProperty("swt.library.path"));
>       SystemOut.info(CliWrapper.class, "init", "*************************************************************");
157c129
<               SystemOut.info(CPDesktop.class, "init", "SWT library deleted: " + swtFile);
---
>               SystemOut.info(CliWrapper.class, "init", "SWT library deleted: " + swtFile);
166c138
<           SystemOut.info(CPDesktop.class, "init", "SWT library dir created: " + swtDir);
---
>           SystemOut.info(CliWrapper.class, "init", "SWT library dir created: " + swtDir);
170c142
<       AppTimer.begin(CPDesktop.class.getSimpleName());
---
>       AppTimer.begin(CliWrapper.class.getSimpleName());
174c146
<       CPDesktop startupController = new CPDesktop(args);
---
>       CliWrapper startupController = new CliWrapper(args);
179c151
<       String msg = "Failed to launch " + CPDesktop.class.getSimpleName() + "; " + e;
---
>       String msg = "Failed to launch " + CliWrapper.class.getSimpleName() + "; " + e;
181c153
<       SystemOut.log(Level.ERROR, CPDesktop.class, "init", msg);
---
>       SystemOut.log(Level.ERROR, CliWrapper.class, "init", msg);
183a156,164
> 
>     Thread.sleep(1000);
>     System.out.println("\n\n");
>     for(String arg : args){
>         Services.getInstance().sendCommand(arg, new MessageReceiverProxy());
>     }
>     System.out.println("\n\n");
>     Thread.sleep(1000);
>     Runtime.getRuntime().halt(0);
188,190c169
<     SystemOut.info(CPDesktop.class, "secondaryMain", "Bring main window forward.");
<     Display disp = MainWindow.getInstance().getShell().getDisplay();
<     ActionManager.run(disp, new ShowMainWindow());
---
>     SystemOut.info(CliWrapper.class, "secondaryMain", "Bring main window forward.");
193c172
<   public CPDesktop(String[] args)
---
>   public CliWrapper(String[] args)
206a186,187
>     appModel = new AppModel(commandLineArguments);
> 
214d194
<     Display.setAppName(appName);
226c206
<         Integer port = (Integer)serviceUI.servicePort.getValue();
---
>         Integer port = (Integer)appModel.getConfigModel().getConfig().serviceUI.servicePort.getValue();
229c209
<         OrgType orgType = orgType.get();
---
>         OrgType orgType = OrgType.CONSUMER;
253,254d232
<     appModel = new AppModel(commandLineArguments);
<     appModel.getConfigModel().addObserver(this);
296,299d273
<     display = Display.getDefault();
<     
<     CPFont.loadFonts(display, appModel.getDesktopProperties());
<     
317c291
<     SystemOut.info(CPDesktop.class, "waitForCustom", "Waiting for custom indicator to appear in " + customMark);
---
>     SystemOut.info(CliWrapper.class, "waitForCustom", "Waiting for custom indicator to appear in " + customMark);
325c299
<       SystemOut.info(CPDesktop.class, "waitForCustom", "Waited " + Formatter.getDurationString(sw.getElapsed()) + " for custom indicator to appear in " + customMark + ", exists=" + customMark.exists());
---
>       SystemOut.info(CliWrapper.class, "waitForCustom", "Waited " + Formatter.getDurationString(sw.getElapsed()) + " for custom indicator to appear in " + customMark + ", exists=" + customMark.exists());
329c303
<       SystemOut.info(CPDesktop.class, "waitForCustom", "InterruptedException while waiting for custom indicator to appear in " + customMark);
---
>       SystemOut.info(CliWrapper.class, "waitForCustom", "InterruptedException while waiting for custom indicator to appear in " + customMark);
373,382d346
<     try
<     {
<       splashWindow = new SplashWindow(display);
<       splashWindow.addListeners(new IListener[] { listener });
<       splashWindow.open();
<     }
<     catch (Throwable e)
<     {
<       log.warn("Unable to show splash. " + e.getMessage(), new Object[] { e });
<     }
388,391d351
<     services.addListener(listener, ConnectedEvent.class);
<     services.addListener(listener, ConnectFailedEvent.class);
<     services.addListener(listener, StatusResponseMessage.class);
<     
405c365
<           CPDesktop.log.info("EXITING... Normally");
---
>           CliWrapper.log.info("EXITING... Normally");
410c370
<           synchronized (CPDesktop.MAIN_MONITOR)
---
>           synchronized (CliWrapper.MAIN_MONITOR)
413c373
<             CPDesktop.MAIN_MONITOR.notifyAll();
---
>             CliWrapper.MAIN_MONITOR.notifyAll();
423,443d382
<     try
<     {
<       while (!display.isDisposed()) {
<         try
<         {
<           if (!display.readAndDispatch()) {
<             display.sleep();
<           }
<         }
<         catch (Throwable e)
<         {
<           log.warn(e.toString(), new Object[] { e });
<           display.sleep();
<         }
<       }
<     }
<     finally
<     {
<       SWTExec.shutdown();
<       System.exit(0);
<     }
454c393
<           CPDesktop.log.info("Restarting service...");
---
>           CliWrapper.log.info("Restarting service...");
462c401
<         CPDesktop.log.info("Connecting to service at " + new Location(host, port));
---
>         CliWrapper.log.info("Connecting to service at " + new Location(host, port));
470c409
<               CPDesktop.log.info("    FAILED on attempt #" + (i - 1) + ", retrying in " + delay + "ms");
---
>               CliWrapper.log.info("    FAILED on attempt #" + (i - 1) + ", retrying in " + delay + "ms");
481c420
<               CPDesktop.log.warn("Unable to establish connection. " + e.getMessage(), new Object[] { e });
---
>               CliWrapper.log.warn("Unable to establish connection. " + e.getMessage(), new Object[] { e });
486c425
<               CPDesktop.log.info("    SUCCESS on attempt #" + i);
---
>               CliWrapper.log.info("    SUCCESS on attempt #" + i);
491c430
<               CPDesktop.log.warn("    FAILED on attempt #" + i + ", aborting because something is seriously wrong.");
---
>               CliWrapper.log.warn("    FAILED on attempt #" + i + ", aborting because something is seriously wrong.");
495c434
<               CPDesktop.log.info("    FAILED on attempt #" + i + ", done");
---
>               CliWrapper.log.info("    FAILED on attempt #" + i + ", done");
513c452
<           CPDesktop.log.error("Interrupted while waiting to connect!");
---
>           CliWrapper.log.error("Interrupted while waiting to connect!");
542c481
<     String localeConfig = (String)getConfigserviceUI.locale.getValue();
---
>     String localeConfig = (String)appModel.getConfigModel().getConfig().serviceUI.locale.getValue();
627,637d565
<     display.asyncExec(new Runnable()
<     {
<       public void run()
<       {
<         CPDesktop self = CPDesktop.this;
<         MainWindow mainWindow = new MainWindow(CPDesktop.display, appModel, services);
<         mainWindow.addListener(listener, new Class[] { MainWindow.Event.AppCloseEvent.class, MainWindow.Event.AppShowEvent.class, AppWindowEvent.WindowReadyEvent.class });
<         
<         new MainWindowController(mainWindow, appModel, services);
<       }
<     });
661c589
<       SystemOut.info(CPDesktop.class, "readLoggingConfiguration", "Log file: " + logfile);
---
>       SystemOut.info(CliWrapper.class, "readLoggingConfiguration", "Log file: " + logfile);
692,699d619
<     CPFont.loadFonts(Display.getDefault(), new Properties());
<   }
<   
<   public static void close()
<   {
<     if (!display.isDisposed()) {
<       display.close();
<     }
